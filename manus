#!/bin/bash
# OpenManus + CodeBuddy SDK æ‰§è¡Œå·¥å…·
# ä½¿ç”¨æ–¹æ³•: ./manus "ä½ çš„ä»»åŠ¡"

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é¡¹ç›®ç›®å½•
PROJECT_DIR="/Users/jasonwang/workspace/OpenManus"
OUTPUT_DIR="$PROJECT_DIR/output"

# CodeBuddy é…ç½®
export CODEBUDDY_CODE_PATH="/Users/jasonwang/.nvm/versions/node/v22.15.1/bin/codebuddy"
export CODEBUDDY_API_KEY="ck_f9gwukdhccn4.j1twF8hHyb_wXzr8pnmeCoSYlA9OF5F8M7RBZvsLeb8"
export CODEBUDDY_INTERNET_ENVIRONMENT=internal

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# æ£€æŸ¥ç¯å¢ƒ
check_environment() {
    print_info "æ£€æŸ¥è¿è¡Œç¯å¢ƒ..."

    # æ£€æŸ¥é¡¹ç›®ç›®å½•
    if [ ! -d "$PROJECT_DIR" ]; then
        print_error "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
        exit 1
    fi

    # æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
    if [ ! -d "$PROJECT_DIR/.venv" ]; then
        print_warning "è™šæ‹Ÿç¯å¢ƒä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
        cd "$PROJECT_DIR"
        # å°è¯•æ‰¾åˆ° ARM64 Python
        if command -v /opt/homebrew/bin/python3 >/dev/null 2>&1; then
            PYTHON_CMD="/opt/homebrew/bin/python3"
        elif command -v /usr/bin/python3 >/dev/null 2>&1; then
            PYTHON_CMD="/usr/bin/python3"
        else
            PYTHON_CMD="python3"
        fi
        $PYTHON_CMD -m venv .venv
        print_success "è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ"
    fi

    # æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ Python æ¶æ„
    VENV_PYTHON="$PROJECT_DIR/.venv/bin/python"
    if [ -f "$VENV_PYTHON" ]; then
        VENV_ARCH=$($VENV_PYTHON -c "import platform; print(platform.machine())" 2>/dev/null || echo "unknown")
        SYS_ARCH=$(uname -m)
        if [ "$VENV_ARCH" != "$SYS_ARCH" ] && [ "$SYS_ARCH" = "arm64" ]; then
            print_warning "è™šæ‹Ÿç¯å¢ƒæ¶æ„ä¸åŒ¹é… ($VENV_ARCH vs $SYS_ARCH)ï¼Œæ­£åœ¨é‡å»º..."
            rm -rf "$PROJECT_DIR/.venv"
            if command -v /opt/homebrew/bin/python3 >/dev/null 2>&1; then
                /opt/homebrew/bin/python3 -m venv .venv
            else
                python3 -m venv .venv
            fi
            print_success "è™šæ‹Ÿç¯å¢ƒé‡å»ºå®Œæˆ"
        fi
    fi

    # æ£€æŸ¥ CodeBuddy CLI
    if [ ! -f "$CODEBUDDY_CODE_PATH" ]; then
        print_error "CodeBuddy CLI æœªæ‰¾åˆ°: $CODEBUDDY_CODE_PATH"
        exit 1
    fi

    # æ£€æŸ¥è¾“å‡ºç›®å½•
    if [ ! -d "$OUTPUT_DIR" ]; then
        mkdir -p "$OUTPUT_DIR"
        print_success "åˆ›å»ºè¾“å‡ºç›®å½•: $OUTPUT_DIR"
    fi

    print_success "ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
ğŸš€ OpenManus + CodeBuddy SDK æ‰§è¡Œå·¥å…·

ç”¨æ³•:
  ./manus "ä½ çš„ä»»åŠ¡æè¿°"
  ./manus --help

ç¤ºä¾‹:
  ./manus "åˆ›å»ºä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ"
  ./manus "å®ç°ä¸€ä¸ªå¾…åŠäº‹é¡¹ç®¡ç†åº”ç”¨"
  ./manus "åˆ†ææ•°æ®å¹¶ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨"
  ./manus "åˆ›å»ºä¸€ä¸ªåŒ—äº¬ä¸‰æ—¥æ¸¸çš„åœ°å›¾è·¯ä¹¦"

é€‰é¡¹:
  --help, -h    æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

è¾“å‡º:
  ç”Ÿæˆçš„æ–‡ä»¶ä¿å­˜åœ¨: $OUTPUT_DIR/

é…ç½®:
  CodeBuddy CLI: $CODEBUDDY_CODE_PATH
  API Key: ***${CODEBUDDY_API_KEY: -8}
  Environment: $CODEBUDDY_INTERNET_ENVIRONMENT

EOF
}

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        print_warning "æœªæä¾›ä»»åŠ¡æè¿°"
        echo ""
        show_help
        exit 1
    fi

    # å¤„ç†å¸®åŠ©é€‰é¡¹
    if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
        show_help
        exit 0
    fi

    # è·å–ä»»åŠ¡æè¿°
    PROMPT="$*"

    echo ""
    echo "ğŸš€ OpenManus + CodeBuddy SDK"
    echo "========================================================================"
    print_info "ä»»åŠ¡: $PROMPT"
    print_info "è¾“å‡º: $OUTPUT_DIR/"
    echo "========================================================================"
    echo ""

    # æ£€æŸ¥ç¯å¢ƒ
    check_environment

    # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
    cd "$PROJECT_DIR"

    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
    source .venv/bin/activate

    # æ£€æŸ¥å¿…è¦çš„PythonåŒ…
    print_info "æ£€æŸ¥ä¾èµ–..."

    # æ£€æµ‹ç³»ç»Ÿæ¶æ„
    SYSTEM_ARCH=$(uname -m)
    PYTHON_ARCH=$(python -c "import platform; print(platform.machine())" 2>/dev/null || echo "unknown")

    # æ£€æŸ¥å…³é”®ä¾èµ–ï¼ˆç‰¹åˆ«æ˜¯ regex, tiktoken, pydantic_coreï¼Œå®ƒä»¬æœ‰æ¶æ„é—®é¢˜ï¼‰
    ARCH_CHECK_FAILED=false

    # æ£€æŸ¥ regex
    if ! python -c "import regex" 2>/dev/null 2>&1; then
        ARCH_CHECK_FAILED=true
    fi

    # æ£€æŸ¥ tiktoken
    if ! python -c "import tiktoken" 2>/dev/null 2>&1; then
        ARCH_CHECK_FAILED=true
    fi

    # æ£€æŸ¥ pydantic_core
    if ! python -c "import pydantic_core" 2>/dev/null 2>&1; then
        ARCH_CHECK_FAILED=true
    fi

    # å¦‚æœç³»ç»Ÿæ˜¯ ARM64 ä½† Python æˆ–åŒ…æ¶æ„ä¸åŒ¹é…ï¼Œå¼ºåˆ¶é‡æ–°å®‰è£…
    if [ "$SYSTEM_ARCH" = "arm64" ] && [ "$PYTHON_ARCH" != "arm64" ]; then
        print_warning "æ£€æµ‹åˆ°æ¶æ„ä¸åŒ¹é…ï¼ˆç³»ç»Ÿ: $SYSTEM_ARCH, Python: $PYTHON_ARCHï¼‰ï¼Œæ­£åœ¨é‡æ–°å®‰è£…..."
        ARCH_CHECK_FAILED=true
    fi

    if [ "$ARCH_CHECK_FAILED" = true ]; then
        print_warning "æ­£åœ¨é‡æ–°å®‰è£…å…³é”®ä¾èµ–ï¼ˆå¼ºåˆ¶ ARM64 æ¶æ„ï¼‰..."
        # ä½¿ç”¨ arch -arm64 å¼ºåˆ¶ ARM64 æ¶æ„
        arch -arm64 pip uninstall -y regex tiktoken pydantic-core pydantic 2>/dev/null || true
        arch -arm64 pip install --no-cache-dir --force-reinstall regex tiktoken pydantic-core pydantic 2>&1 | grep -v "already satisfied" || true

        # éªŒè¯å®‰è£…ï¼ˆä½¿ç”¨ arch -arm64 ç¡®ä¿æ¶æ„æ­£ç¡®ï¼‰
        if [ "$SYSTEM_ARCH" = "arm64" ]; then
            if ! arch -arm64 python -c "import regex; import tiktoken; import pydantic_core" 2>/dev/null; then
                print_error "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œç£ç›˜ç©ºé—´"
                exit 1
            fi
        else
            if ! python -c "import regex; import tiktoken; import pydantic_core" 2>/dev/null; then
                print_error "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œç£ç›˜ç©ºé—´"
                exit 1
            fi
        fi
        print_success "å…³é”®ä¾èµ–å·²é‡æ–°å®‰è£…"
    fi

    # æ£€æŸ¥å…¶ä»–ä¾èµ–ï¼ˆåŒ…æ‹¬å¯èƒ½æœ‰æ¶æ„é—®é¢˜çš„åŒ…ï¼‰
    MISSING_DEPS=false
    ARCH_PROBLEM_PACKAGES=""

    # æ£€æŸ¥åŸºç¡€ä¾èµ–
    if ! python -c "import pydantic, openai, codebuddy_agent_sdk, browser_use, baidusearch" 2>/dev/null; then
        MISSING_DEPS=true
    fi

    # æ£€æŸ¥å¯èƒ½æœ‰æ¶æ„é—®é¢˜çš„åŒ…
    for pkg in jiter primp; do
        if ! python -c "import $pkg" 2>/dev/null 2>&1; then
            ARCH_PROBLEM_PACKAGES="$ARCH_PROBLEM_PACKAGES $pkg"
            MISSING_DEPS=true
        fi
    done

    if [ "$MISSING_DEPS" = true ]; then
        print_warning "ç¼ºå°‘ä¾èµ–ï¼Œæ­£åœ¨å®‰è£…..."
        # å¦‚æœç³»ç»Ÿæ˜¯ ARM64ï¼Œä½¿ç”¨ arch -arm64 å¼ºåˆ¶ ARM64 æ¶æ„
        if [ "$SYSTEM_ARCH" = "arm64" ]; then
            PIP_CMD="arch -arm64 pip"
        else
            PIP_CMD="pip"
        fi

        # å…ˆå®‰è£…å¯èƒ½æœ‰æ¶æ„é—®é¢˜çš„åŒ…ï¼ˆå¼ºåˆ¶ ARM64ï¼‰
        if [ -n "$ARCH_PROBLEM_PACKAGES" ]; then
            print_info "å®‰è£…æ¶æ„æ•æ„Ÿä¾èµ–ï¼ˆå¼ºåˆ¶ ARM64ï¼‰..."
            $PIP_CMD install --no-cache-dir --force-reinstall $ARCH_PROBLEM_PACKAGES 2>&1 | grep -v "already satisfied" || true
        fi

        # å®‰è£…å®Œæ•´ä¾èµ–ï¼ˆä» requirements.txtï¼‰
        if [ -f "$PROJECT_DIR/requirements.txt" ]; then
            $PIP_CMD install -q --no-cache-dir -r "$PROJECT_DIR/requirements.txt" 2>&1 | grep -v "already satisfied" || true
        else
            # å¦‚æœæ²¡æœ‰ requirements.txtï¼Œå®‰è£…æ ¸å¿ƒä¾èµ–
            $PIP_CMD install -q --no-cache-dir pydantic tenacity loguru boto3 aiofiles colorama structlog pyyaml codebuddy-agent-sdk browser-use baidusearch 2>&1 | grep -v "already satisfied" || true
        fi
        print_success "ä¾èµ–å®‰è£…å®Œæˆ"
    else
        print_success "ä¾èµ–æ£€æŸ¥å®Œæˆ"
    fi

    # æ£€æŸ¥ run_with_manus_agent.py æ˜¯å¦å­˜åœ¨
    if [ ! -f "$PROJECT_DIR/run_with_manus_agent.py" ]; then
        print_error "æ‰¾ä¸åˆ° run_with_manus_agent.py"
        exit 1
    fi

    # è¿è¡Œä»»åŠ¡
    print_info "å¼€å§‹æ‰§è¡Œä»»åŠ¡..."
    echo ""

    # ä½¿ç”¨ exec ç¡®ä¿æ­£ç¡®çš„é€€å‡ºç ä¼ é€’
    # ä½¿ç”¨ arch -arm64 ç¡®ä¿ä½¿ç”¨ ARM64 æ¶æ„è¿è¡Œ Python
    # è¿™æ ·å¯ä»¥é¿å…æ¶æ„ä¸åŒ¹é…çš„é—®é¢˜
    if [ "$SYSTEM_ARCH" = "arm64" ]; then
        exec arch -arm64 python run_with_manus_agent.py --prompt "$PROMPT"
    else
        exec python run_with_manus_agent.py --prompt "$PROMPT"
    fi

    EXIT_CODE=$?

    echo ""
    echo "========================================================================"

    if [ $EXIT_CODE -eq 0 ]; then
        print_success "ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
        echo ""
        print_info "ç”Ÿæˆçš„æ–‡ä»¶ä½äº: $OUTPUT_DIR/"
        echo ""
        echo "æŸ¥çœ‹æ–‡ä»¶:"
        echo "  cd $OUTPUT_DIR"
        echo "  ls -la"
    else
        print_error "ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç : $EXIT_CODEï¼‰"
        exit $EXIT_CODE
    fi

    echo "========================================================================"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"

